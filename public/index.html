<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<style type="text/css">
body {
    background-image: url('images/sl-cem-header.png');
    background-size: 2500px 200px;
}
#logo {
    height: 100px;
    padding-bottom: 20px;
}
.hdr-bar {
    background-color: rgb(175, 186, 126);
}
.ftr-bar {
    background-color: rgb(73, 80, 40);
}
.bld-text {
    color: rgb(97, 58, 40);
}
#hdr-row {
  margin-top: 8px;
  margin-bottom: 8px;
}
#search-btn {
  margin-top: 4px;
}
#reset-btn {
  margin-top: 4px;
}
.hdr-text {
  font-size: 22pt;
  color: black;
}
.hdr-text-1 {
  font-size: 22pt;
  color: grey;
}
.hdr-text-2 {
  font-size: 22pt;
  color: lightBlue;
}
.btn-toolbar {
  margin-left: 0px;
  padding: 6px;
  padding-top: 4px;
  background-color: lightGrey;
  background-color: rgb(175, 186, 126);
}
.dropdown-menu {
  padding: 8px;
}
#error-message {
  min-height: 1em;
  color: red;
  font-weight: bold;
}
</style>
<script src="https://maps.googleapis.com/maps/api/js"></script>
<script>
// The main map.
var map;
// This is only one infowindow.  We will just move it around.  Callbacks will
// set the content.
var infowindow;
var markers;
var missingMarker;
var defaultMapCenter;
var missingLatLng;
function initialize() {
  //defaultCenter = new google.maps.LatLng(42.634739, -95.174137);
  defaultMapCenter = new google.maps.LatLng(42.634739, -95.173137);
  missingLatLng = new google.maps.LatLng(42.633739, -95.175087);

  // Map props can be hardcoded.  The cemetery is unlikely to get up and move away.
  var mapProp = {
    center: defaultMapCenter,
    //zoom:18,
    zoom:17,
    mapTypeId:google.maps.MapTypeId.SATELLITE
  };

  map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
  infowindow = new google.maps.InfoWindow(); // content prop to be set later

  markers = new Array();

  missingMarker = new google.maps.Marker({
      position: missingLatLng,
      icon: 'images/markers/red.png',
      map: null
  });
  google.maps.event.addListener(missingMarker, 'click', function(evt) {
      openInfowindow(this);
  });
}

function bitPitEgg() {
  var burial = {
    id            : 0,
    sd_type       : "",
    sd            : "",
    lot           : "",
    space         : "",
    lot_owner     : "",
    year_purch    : "",
    first_name    : "The Bit Pit, ",
    last_name     : "Home of BVU Computer Science",
    sex           : "",
    birth_date    : "N/A",
    birth_place   : "",
    death_date    : "N/A",
    age           : "",
    death_place   : "",
    death_cause   : "",
    burial_date   : "",
    notes         : "",
    more_notes    : "",
    hidden_notes  : "",
    lat           : 42.641333,
    lng           : -95.211234,
    img           : ""
  };
  return burial;
}

/**
 * Clears burial markers and the missing marker.
 */
function clearMarkers() {
  console.log(markers);
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
    if (missingMarker != markers[i]) {
      markers[i] = null;
    }
  }
  while (markers.length > 0) {
    markers.pop();
  }

  //placeMarker( bitPitEgg() );
}

/**
 * Creates burial markers for any results with valid lat/lng.
 * Activates missing marker for results without a lat/lgn.
 */
function updateMarkers(ary) {
  for (var i = 0; i < ary.length; i++) {
    if (ary[i].lat != 0 && ary[i].lng != 0) {
      // Place burial marker.
      console.log('placing marker ' + i + ', coords ' + ary[i].lat + ',' + ary[i].lng);
      marker = makeBurialMarker(ary[i]);
      markers.push(marker);
    } else {
      if (missingMarker.map != map) {
        // Activating missing marker.
        console.log('activating missing marker');
        missingMarker.setMap(map);
        missingMarker.numberMissing = 0;
        markers.push(missingMarker);
      } else {
        missingMarker.numberMissing++;
      }
    }
  }
  console.log(markers);
}

function openInfowindow(marker) {
  if (marker == missingMarker) {
    infowindow.setContent('There are ' + marker.numberMissing + ' additional people '
                        + 'buried in the cemetery<br/>'
                        + 'that match your criteria, but we don\'t have location<br/>'
                        + 'information for them yet.  Please bear with us while we<br/>'
                        + 'update our site.  Thank you.');
  } else {
    var content = "<h4>" + marker.first_name + " " + marker.last_name + "</h4>"
                + "<br/><img style=\"width: 200px;\" src=\"/api/img-download/"
                      + marker.id + "\" /><br/>"
                + "Born Date: " + marker.birth_date
                + "<br/>"
                + "Born Place: " + marker.birth_place
                + "<br/>"
                + "Death Date: " + marker.death_date
                + "<br/>"
                + "Death Place: " + marker.death_place
                + "<br/>"
                + "Burial Date: " + marker.burial_date
                + "<br/>"
                + "Lot Owner: " + marker.lot_owner;
    infowindow.setContent(content);
  }
  infowindow.open(map, marker);
}

function makeBurialMarker(burial) {
  var marker = new google.maps.Marker({
      position: new google.maps.LatLng(burial.lat, burial.lng),
      icon: 'images/markers/green-dot.png',
      map: map
  });

  // Add info to the marker so that we can display it later in the infowindow.
  marker.id =            burial.id;
  marker.sd_type =       burial.sd_type;
  marker.sd =            burial.sd;
  marker.lot =           burial.lot;
  marker.space =         burial.space;
  marker.lot_owner =     burial.lot_owner;
  marker.year_purch =    burial.year_purch;
  marker.first_name =    burial.first_name;
  marker.last_name =     burial.last_name;
  marker.sex =           burial.sex;
  marker.birth_date =    burial.birth_date;
  marker.birth_place =   burial.birth_place;
  marker.death_date =    burial.death_date;
  marker.age =           burial.age;
  marker.death_place =   burial.death_place;
  marker.death_cause =   burial.death_cause;
  marker.burial_date =   burial.burial_date;
  marker.notes =         burial.notes;
  marker.more_notes =    burial.more_notes;
  marker.hidden_notes =  burial.hidden_notes;
  marker.lat =           burial.lat;
  marker.lng =           burial.lng;           

  google.maps.event.addListener(marker, 'click', function(evt) {
      openInfowindow(this);
  });

  return marker;
}


google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>

<body>
<div class="container">
  <div id="hdr-row" class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
<!--
      <span class="hdr-text-1">storm</span><span class="hdr-text-2">lake</span> &nbsp;<span class="hdr-text">cemetery</span>
-->
    <img id="logo" src="images/sl-cem-logo.png">
    </div>

    <div class="btn-toolbar col-xs-12 col-sm-12 col-md-12 col-lg-12">

      <div class="btn-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <button type="button" class="btn btn-default" id="reset-btn">
          Reset
        </button>
        <button type="button" id="search-btn" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
          Search <span class="caret"></span>
        </button>
        <div class="dropdown-menu" role="menu">
          <form>
            <p>Search for a loved one by entering information into any of the following fields.</p>
            <p>First Name: <input id="first_name" type="text"></p>
            <p>Last Name: <input id="last_name" type="text"></p>
            <p>Place of Birth: <input id="birth_place" type="text"></p>
            <p>Year of Birth: <input id="birth_date" type="text"></p>
            <p>Place of Death: <input id="death_place" type="text"></p>
            <p>Year of Death: <input id="death_date" type="text"></p>
            <p>Owner of Lot: <input id="lot_owner" type="text"></p>
            <p id="error-message"></p>
            <input id="do-search-btn" type="button" value="Find" />
          </form>
        </div>
      </div>

    </div>

  </div>

  <div class="row">
    <div id="googleMap" style="height:450px;"></div>
  </div>

</div>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript">

function handleSearchResponse(res) {
  res = eval(res);
  clearMarkers();
  if (res.length == 0) {
    $('#error-message').html('No results found.');
  } else {
    updateMarkers(res);
    $('#search-btn').dropdown('toggle');
    $('#error-message').html('');
  }
}

$(document).ready(function() {
  $('.dropdown-menu input, .dropdown-menu label').click(function(e) {
    // Prevent clicks on the dropdown from dismissing the dropdown.
    e.stopPropagation();
  });

  $('#do-search-btn').click(function(e) {
    // Make 'searching' feedback, probably next to do-search-btn.
    // Fire jQuery Ajax req
    $.post( '/api/search',
      {
        first_name:  $('#first_name').get(0).value,
        last_name:   $('#last_name').get(0).value,
        birth_place: $('#birth_place').get(0).value,
        birth_date:  $('#birth_date').get(0).value,
        death_place: $('#death_place').get(0).value,
        death_date:  $('#death_date').get(0).value,
        lot_owner:   $('#lot_owner').get(0).value
      },
      handleSearchResponse );
    });


    $('#reset-btn').click(function(e) {
      clearMarkers();
      map.panTo(defaultMapCenter);
    });

/*
    $('.btn-group').on('show.bs.dropdown', function () {
      console.log('got .dropdown-menu show.bs.dropdown');
    });    
    $('.btn-group').on('hide.bs.dropdown', function () {
      console.log('got .dropdown-menu hide.bs.dropdown');
    });   
*/  
});


</script>
</body>

</html> 
