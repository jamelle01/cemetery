<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<style type="text/css">
#hdr-row {
  margin-top: 8px;
  margin-bottom: 8px;
}
#search-btn {
  margin-top: 4px;
}
#reset-btn {
  margin-top: 4px;
}
.hdr-text {
  font-size: 22pt;
  color: black;
}
.hdr-text-1 {
  font-size: 22pt;
  color: grey;
}
.hdr-text-2 {
  font-size: 22pt;
  color: lightBlue;
}
.btn-toolbar {
  margin-left: 0px;
  padding: 6px;
  padding-top: 4px;
  background-color: lightGrey;
}
.dropdown-menu {
  padding: 8px;
}
</style>
<script src="https://maps.googleapis.com/maps/api/js"></script>
<script>
var map;
// This is only one infowindow.  We will just move it around.  Callbacks will
// set the content.
var infowindow;
var markers;
var defaultCenter;
function initialize() {

  defaultCenter = new google.maps.LatLng(42.634739, -95.174137);

  // Map props can be hardcoded.  The cemetery is unlikely to get up and move away.
  var mapProp = {
    center: defaultCenter,
    zoom:18,
    mapTypeId:google.maps.MapTypeId.SATELLITE
  };

  map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
  infowindow = new google.maps.InfoWindow(); // content prop to be set later


  markers = new Array();

  // Bit Pit "Easter Egg"
  placeMarker( new google.maps.LatLng(42.641333, -95.211234) );
}

function clearMarkers() {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
    markers[i] = null;
  }
  while (markers.length > 0) {
    markers.pop();
  }
}

function updateMarkers(res) {
    var ary = eval(res);
    for (var i = 0; i < ary.length; i++) {
        placeMarker(ary[i]);
    }
    if (ary.length == 1) {
        // Single marker: go ahead and open its infowindow.
        openInfowindow(markers[0]);
    }
}

function openInfowindow(marker) {
    var content = "<h4>" + marker.first_name + " " + marker.last_name + "</h4>"
                + "Born: " + marker.birth_date
                + "<br/>"
                + "Died: " + marker.death_date;
    if (marker.img !== undefined)
        content = content + "<br/><img style=\"width: 200px;\" src=\"" + marker.img + "\" />" 
    // FIXME Following code is for demo purposes only.  It must be removed prior to production.
    else if (marker.last_name == "Anderson")
        content = content + "<br/><img style=\"width: 200px;\" src=\"/images/hs-anderson.jpg\" />" 
    infowindow.setContent(content);
    infowindow.open(map, marker);
}

function placeMarker(burial) {
    var marker=new google.maps.Marker({
        position: new google.maps.LatLng(burial.lat, burial.lng),
        map: map
    });
    // Add info to the marker so that we can display it later in the infowindow.
    marker.sd_type =       burial.sd_type;
    marker.sd =            burial.sd;
    marker.lot =           burial.lot;
    marker.space =         burial.space;
    marker.lot_owner =     burial.lot_owner;
    marker.year_purch =    burial.year_purch;
    marker.first_name =    burial.first_name;
    marker.last_name =     burial.last_name;
    marker.sex =           burial.sex;
    marker.birth_date =    burial.birth_date;
    marker.birth_place =   burial.birth_place;
    marker.death_date =    burial.death_date;
    marker.age =           burial.age;
    marker.death_place =   burial.death_place;
    marker.death_cause =   burial.death_cause;
    marker.burial_date =   burial.burial_date;
    marker.notes =         burial.notes;
    marker.more_notes =    burial.more_notes;
    marker.hidden_notes =  burial.hidden_notes;
    marker.lat =           burial.lat;
    marker.lng =           burial.lng;           
    marker.img =           burial.img;
    markers.push(marker);
    google.maps.event.addListener(marker, 'click', function(evt) {
        openInfowindow(this);
    });
}


google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>

<body>
<div class="container">
  <div id="hdr-row" class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <span class="hdr-text-1">storm</span><span class="hdr-text-2">lake</span> &nbsp;<span class="hdr-text">cemetery</span>
    </div>


    <div class="btn-toolbar col-xs-12 col-sm-12 col-md-12 col-lg-12">

      <div class="btn-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <button type="button" class="btn btn-default" id="reset-btn">
          Reset
        </button>
        <button type="button" id="search-btn" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
          Search <span class="caret"></span>
        </button>
        <div class="dropdown-menu" role="menu">
          <form>
            <p>Search for a loved one by entering information into any of the following fields.</p>
            <p>First Name: <input id="first_name" type="text"></p>
            <p>Last Name: <input id="last_name" type="text"></p>
            <p>Place of Birth: <input id="birth_place" type="text"></p>
            <p>Year of Birth: <input id="birth_date" type="text"></p>
            <p>Place of Death: <input id="death_place" type="text"></p>
            <p>Year of Death: <input id="death_date" type="text"></p>
            <p>Owner of Lot: <input id="lot_owner" type="text"></p>
            <input id="do-search-btn" type="button" value="Find" />
          </form>
        </div>
      </div>

    </div>

  </div>

  <div class="row">
    <div id="googleMap" style="height:530px;"></div>
  </div>

</div>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript">

function handleSearchResponse(res) {
    // Remove 'searching' feedback and hide dropdown-menu
    // If error, show message (example: "No one matching criteria found")
    // Else, clearMarkers, then iterate through results and placeMarker each
    //          Also, if only one result, open infowindow...
    if (res.length == 0) {
        console.log("We ain't found squat!");
    } else {
        console.log('clearing markers');
        clearMarkers();
        console.log('updating markers');
        updateMarkers(res);
    }
    console.log('toggling dropdown');
    $('#search-btn').dropdown('toggle');
    console.log('done');
}

$(document).ready(function() {
    $('.dropdown-menu input, .dropdown-menu label').click(function(e) {
        // Prevent clicks on the dropdown from dismissing the dropdown.
        e.stopPropagation();
    });

    $('#do-search-btn').click(function(e) {
        // Make 'searching' feedback, probably next to do-search-btn.
        // Fire jQuery Ajax req
        $.post( '/api/search',
                {
                    first_name:  $('#first_name').get(0).value,
                    last_name:   $('#last_name').get(0).value,
                    birth_place: $('#birth_place').get(0).value,
                    birth_date:  $('#birth_date').get(0).value,
                    death_place: $('#death_place').get(0).value,
                    death_date:  $('#death_date').get(0).value,
                    lot_owner:   $('#lot_owner').get(0).value
                },
                handleSearchResponse );
    });


    $('#reset-btn').click(function(e) {
        clearMarkers();
        map.panTo(defaultCenter);
    });

    $('.btn-group').on('show.bs.dropdown', function () {
        console.log('got .dropdown-menu show.bs.dropdown');
    })    
    $('.btn-group').on('hide.bs.dropdown', function () {
        console.log('got .dropdown-menu hide.bs.dropdown');
    })    

});


</script>
</body>

</html> 
